from collections import namedtuple
import numpy as np

Tetromino = namedtuple('Tetronimo', ['fall_check', 'footprint', 'height', 'move_check', 'width'])

JETS = '>>><<<>>><<<>><<>><<>>>><>>>><><<><<<>>>><<<>>>><<<>><><><><<><<<>><>>><>>>><<>>>><<<<>>><><<>>><<<<><<<>><>><<<<>><<<<><<<<><><<<><<<>>><><<>>><<>>><<<<>><>>><<<<>>>><<<<><>>>><<<><<>><>><<<><<<>>>><<<<>><>>><>>>><<><<<><<>><<>>>><<<>><<<>>><<<<><<>><<><>><<>>><<<>>>><<<>>><<<<>><>>>><<<<>><<><<<>>>><<<>><<><<<<>><<>>>><<<<><<<<>>>><<<<>>><>><<<<><<<>><<<<>>>><<<>>><<<<>>>><<<<>>><<<>><>><<<><<>>>><<<>>><<<>><<<>>><<<<>><><<<<>>><<>>>><>><<>><<<><>><>>><<><<<<>>>><<<<>>><<>><>>><<<<><<>><<>><>>>><<<<><<<>>>><<>>><<<>><<><<><<>>><<<>>>><<<<>>><<>>>><<<<>>>><>>><><>>><<<>><<<<><>>>><<>><<>><<<>>>><<<<><<>>>><<>>>><<>><>>>><<>>>><<<><<>><>>><<>>><<><>>>><<<<>>>><<>><<<<>>><<>><>><><<<>>>><<<><<<>><><>>>><<<<>>><>><>><><<>>>><<>>><<><<<<>>>><<<>>><>>><<<<>>><<>>><<<>>><<<>>><<<>>><<<<>>><<<>><><<<<>>>><<<><<<<>><<<>><><<<<>>>><<><<<<>>>><<<<>><<<><>><<<<>><<><<<<>>>><>>><><><><<>>><<<>>>><<<<><<<><<<<><<<>>><<<><>><<<><<<<>>><<<>>><<>>><<<<><><<<<><<<<>>><<>>><>>>><<<>><<>>><<>>><><><<<><><<<<>>><<<<>><<<><<<<>>><>>>><><<<<><<<>>>><<<<>>>><<<<>><<<<>><<<<>><>><>>>><<>><>>><<<><>>><<<>>>><>><>>>><<>><><<<<>>>><<>><<<><<<>>>><>>>><<<<>><>>>><<<<><<<<><>>>><<<<>><<<>>>><<><<<<>>>><<<>><<<<>>>><<<<>><<<<>>>><>><<>>>><<<<><<<>><<<<><<<<>>><<<>><<<<>>><<<<>><<<<>>>><>>><<>>>><<>><<<<><<>>><><<<<>>>><<<>><<<<><<>>>><>><<<>>>><>><<>>><<<>>>><<<<>><<<>><<<><<<<>>>><<<<>>>><<<<>><<<><>>>><<<<>>>><<<>>>><<>>><<>>>><<>><<<<><<<>>>><<<>>>><<<<>><<<<>>>><<><<>>>><<<<>>>><>><<<<>><<<><<<><<<<>><<<<>>><<>>>><><<<<>>>><<<<><>>><<<<>><>><<>>><<<<>>><<>><<<>>><<<>>><>><<>><>><>>>><<<>>>><<<><>>>><>>>><><>>>><<>>>><<<<>><<>>>><<<<>><<<<>><<<>>><<<<>><>>><<>>><<<>><<<<>>><>>>><<<<><<<><>>>><<<<>>><>>>><>><<><<<><<<>>><<<<>>>><>><<<<>><><<><<>>>><<<>>>><<>>>><>>><<<<>>><<<<>>>><<>><<>>>><><>><<<<>>>><<<>><<>>><<<><<<>>>><<>><<<>><<<<>>><<<><<<><><<<>><>>><>><<<<>>>><>>>><<<<><>>><<>>><>>>><<>>><<<>>>><>>><<<<>>>><<>>>><<<><<<><<>>><<<<>><>>>><<<>>><<<<>>>><<<<>><<<>>>><<<>><<><<>><<<<>>><>><>>>><<<>><<<>>>><<<><<>>><>>>><<<<><>>>><<>>><<<>>>><<<><<><<>>><<>><<<>>><>>><<<><>><<>>><<<>>><<<<>>>><><<>>>><<<>>><<<<>>><>>>><<<<>><<>>><<>>>><<>>>><>><>>>><<><><<<<>>>><<<<>><<<>><<<><<<>>>><<<>>><>>>><<><<>>><<>>>><><<<><<<<>><<<<>>><<<><>>><<>>>><<<>>><<>><<>>><>><<<<>>>><>><<>>>><<<<>><>><<<>>>><<<>><<>>>><>>>><<><<<>>><>>>><<<>>><<><<<<>>><<>>>><<<>><<<>>><>>><>><<<>>>><>><<><<>><><>>><>>><<>><>><<<<>>>><<>>>><<<<>>>><><>>><<>>>><><>><>>><<<><<<>>>><><<<<>>><<<>>><>>>><<<<>>>><<<<>>>><<<>>><<<<><<>><<>><<<>>><>>><<>><>>>><<<>><<<>>>><<<<>><<<<>><<<><<<>>>><<>>>><<<<><<<>><>><<<<>>><<<>>>><<<<>>>><<<>>><<<><>><>><><<<>><<>><>>><<<><<<><<<<>>>><><<<>><>>>><<<>>><<>><><>>>><><<<><<>><<<>>>><<>><<<<>>><<<><<<>>><<>><<>><<>><<<<><<>><>>>><<<<>><>><<<><>>>><<<<><<>><<<<>><<<>><<><<<<>>>><>><<<><<<<>>>><<<<>>>><>>>><<>>><<>>>><<>>>><>>>><<>>><<<><><<>><><<<<><>>>><>><<<>>><<<>>>><<>><<>>>><<<<>>><<>><><<<><<<<><<<><<>>><>>><<<<>>><<<>><>><>><<<>>>><><<<<>><>>><<<>><<<<>>>><<>><<<>>><<>>><><<<>>>><<<>><<<><>><<<>><<<>><<<>>><<<<><>>><><<<<>><>>><<<<>>><<<<>>><>>>><<<<>><>>>><<<>>><<<><<<<>>>><<<>><<<<>>><<<<><<<><>><<<>>>><<>>><<<>>><>>>><<<<>>>><<<<>>>><>>><>>><><<<<>><<>>>><<<>>><<>>>><<<>>><>>>><>>>><<<>>><>><<>><>>>><<>>>><<>><<<<>><>>><<<>>><>>><<>><<<>>><<>>><<<>><<>>>><<>>>><<>><<<><<<>><>>>><<<>>><<>>><<>><>><><<<<>>>><>>><>><>>>><<<<>>>><<>>>><><<>>><<>>><<><<<<><<>><<<<><<>>>><>>>><><>>><>><<<<>>><>>><<>><<<>><>>><<><<<<>>><><><<<<>><<<>><>><<<>><<<<>>><<<>><<<<>>>><<<>>>><>>><<<<><>>>><<<<>>>><><<>>>><>>><<>>><<>>>><<>>>><<>>>><>>>><>>>><>><<><>>><<<>><>><<><<<<>>><<<>>><>><<<>>><<<<>>><<>>><>>>><<<<><<>><>>><<<<><<<>>>><<<><<>><<>><><<>>><<<>><<<>>><>><<<>>><>><<<>>><><<>>>><<<<>>><<<><<>>>><><<>>>><<<>>><>>><<<>>>><<<>><><<<<>>><<>>>><<<>><<>><<<>>>><<<>>><>>><>>><<><<>>>><<<>>>><<<<>>>><<<<><><<<<><<>><<>><>>>><<>><<>>><>>><<>><<<<>>>><<>>><><<><>>><<>>>><<><<>>><<>><<>><<<<>><<<<>><>>><<>><<<>>>><<<>><>>><<<<>>><>>>><<>><<>>>><<<<>>><<<<>>><>>><<<>>>><<<<>><<<><<<>>>><<<>>><>>>><<<<>><>>>><>>><<>><<<<><<>>>><<>>><<<>>><<<<><>><<<<>><>>>><<><<<<><<<>>><><>>><<<<><>>>><<<><<<><<<<><<>><>><<<<>>>><<<>>>><>><>>><><>>><<>><>><<>><>>><>>><>>><><<>><<<>>><<<>>><<<<>>>><<>>>><<><<<>>><<>>>><>>>><<<<>><><<>>>><<>><<<>>>><<<>><>><<>><<<<><<>>>><<<<>>><<<<>><<>><<<>>>><<<<>>><<<<>>><>>><<<<>>>><<<<>>>><<>>>><>><<<><<<<>><<>>><<>><<<<>>>><<<<>>>><<>>>><<>>><<<>><<<><<><><>>>><>><<<<><>>>><><<>><<<<>><<>>><>>>><<<>>><<<<>>><<>><<<<>><><<<<>><<<<>>><<><>>><<>><<<<>>>><<<<>>><<<<><<<<>><>>>><<>>><<<>><<<<>><<<<><<<>>>><<<>><<>>>><<<>>>><<><>>>><>>><<>><<<<><<<<>><<<<>>><><<>><<<<>>><<<>>>><<<><<<<><<>>>><<><<<<>><<<<>>>><<<>><>><<<<>><<<<>>>><<<<>><<<>>>><<<<>>>><<<>>><<<>>><<<<>>>><<<<>>>><<>>><<<<><<<<>><<<>><<<<>>><<<<>><<<<><<<<>><>><<>><<<>>><<<><<<<>><<>><<<>>><<>>>><<>><>>><<<<>><><>>><<<<>><><><<<>><<<<>>>><<<>>>><<<<>>>><<<>><<<<>>><<<>>><>><<><<>><<><<><><>>>><>>>><<<><<>>>><<<><<>><<<>><<<<>><<>>>><<<>>>><<<><<>>>><<>><<><<>>>><<<>>>><<<<>>><<<<>>><<>><>><<<>>>><<<<><<<>>>><<<<><>>><<<>>>><<<>><>>>><><<>>><<>>><<<>>>><<><<<>>>><<<><<<>>><<>>>><>><<<<><>>>><<<>>><<<<><<>><><<<><><>><<<<>>><<<>><<<<><<<<>><<>>>><><<<<>>>><<<>>><<>>>><<>>>><>><<<<>><<<><<>><<>>><<<<>>>><<<>>><>><>><<<><>>><<<<>><>><>>>><<><>>><<<>><<<<>>>><>>><<<<>><<<<><<<>><<<<><<<<>>><>>><<<<>>><>>>><<><<<>>>><<<<><<<<>>>><<<>>>><<<<>>><<<<>><<<<><<<>>>><><<<<><<<>><>>>><<<<>>>><<>>><<>><<<<>>><<>><<<<>>>><><<<<><<>>><<<<>><<<<><<>><<<>>><><><<>>><>>>><<>>><>>>><<<>><<<<>>>><>>><<<>>><<>>><<<<>><><><<<><<><<<>>><<>>>><><<<<>><<>>>><<<>>>><<<<>><<>><<<<>>><><<<<>>>><<<<><<<<><>>><>>><<>><<<>>>><<<<>>>><<><>><<<>>>><>>><<<>>>><<>><<<<>>>><<<>>>><<<>>>><<><>>><<>>><<<<><<>>>><>>><<<>>>><<<<>>><<><><>><><<<<><<<<><<<>>>><<<<>>><<<<>><<>><<<<>>><>>>><<<>>><<>>><>><<>><<>>><<>>><<<><<<>>>><><<><><<<<>>>><<>>><<<<>>><<<><<<<>><>>><<<<><<<<><<>>>><>><<<>>>><<>><><<<>><<>><<<<>>>><>><<<<>>>><<<<><>><>>>><<<><><<>>>><<<<>>>><<<<>>><>>>><<<<>>>><<<>><<<<>>>><<<<>>><>><><<<<>><<>>><<>>>><<<><>>><>>>><<<>>>><<<>>>><<<<><<<>>>><>>>><<<<>>><>>>><<><<<>>><<>><>>><>><>>><>>>><<<<>>><>>><<<<>>><<<>>>><>><<<<>>>><<<<><<>>>><<><>>>><<<<>>>><<<<>>>><<>>><>>>><<<<>>>><<<>><><>><>>>><<<<>>><<<>>>><><<>>>><<<<><<<>>><<>>>><<>><<<<>>>><><<<<>>><<>><>><>><<<<>>><<<><<<><<<<>>><<>>><<<<><<<<>><><>><>>>><>>>><<<>>>><<<><<><><><<>>>><<<<>>><<>>><>>><<<<>><><><<<>>>><<>>><<<><<<<>>>><<<<>>>><<<<><<<<>>>><<<>>><<<<>>><<>><<<<><<><>>>><><<<><<<><<>>><<<<>>>><<>><><>><<>><<<>><>><>><<<>><><<<>><><>>>><<>>>><<<><<><>>><<>>><<<<>>>><>><<>>>><<<><<<<>>><>>>><<>>><<<<>>>><>>><><>>><<<<>>><<<<>>>><<<>>>><<><><<>>>><><<><<<<>><<<<>>><<>>><<<>><>>>><<<>><<<>>>><>><>><><>>><>>><<<>>>><>><<<<>>>><<<<>>>><<<>>>><>><<<<><<<<><<<>><<>>>><<<<>><<<><<<<><<>>>><><<<><<<<>><<<><<><<<<>>>><<<<>><<>>>><<<<><><<<><<>><<<<>>><<<>><<<>>>><>><<<<>>><<<>>>><>>><>>><<<<>>>><<<>><<>>><<<<><>>>><<<<>>>><><<<>>><>>>><<<<><><<<<>>>><<<>>>><<<>><>><<<<>>>><<<<>>>><>>><<<<>>><<>>>><>><<<<>>><<<<>><<<>>><>>><<<>>><><<<<>>><<<<>>>><<<>>><<<>>>><<<<><<<>><<>><<<<>>><>><<<>>><>><<<>>>><<<<>>>><<<<>><<>><<>><>><><<>>><<<<><<<>><<<<>>><<><<<>>>><<<<>><>>><><<<>>><<>>><<<<><<>><<<<><>>>><><<<<>>><><<<><<<><<<>><<>>><<><>>><>>>><<<>>><<<>>><<>><<><>><<>><>>><<<<><<>>>><<>>>><<<>><<>>><><><<>>><>>><><<<>>><<<>>><<>><>>><>><<>><<>>>><<<>><<<<>>>><<<<><<<<>>>><<<>>><>><>>>><<<>>>><<<><<<><<<<><<<>><<>><<>><<<><<><<<<>>>><<<>>><<<>>>><<<<>>>><<<><>>>><><<>>><<<><><<<<><<<>>>><<><<<<><>>><<<><<<<>>>><<<<>>><><<<<>>><<<<>><<<<>>><<>><>><><<<<><<>>>><<<>><<<><<<>>><>><<><>>>><<<<>>>><<<>><<<><<><<<><<>><<<<><<<>>><><<<><<<><>><<>>><<<>><>>><<<>><>><<<>>><<>>><>><>>><>>><<<><<>>>><<<>><<><<<>>>><><<>><<<<><<>>>><>>>><<<<>><>>>><<<<>><<<><<><>>><<<>>><<<<>>><<>>><<>><<<>><>>><<>>>><<>><<<>>>><<<>><>>><>>>><>>>><<>><<<<><<<>>>><<<>>>><<>><<<<>>><<><<><<<><<<><>><<<<>>>><<<>>>><<<><<<><<<<>>>><<<<>>>><<<>>><<<<>><<>>>><<>><>>><>><><><<<<>>><<<<><>>>><>>><<<<>>><>>>><<<>><<<<>>><<>>>><>>>><><<<<>>><<<<><<<>>><<<>><>><<>><>>><<<>>>><>>>><<<>>><<><<<>>><>>>><><<>>><<<<><<>>><<<<>><><<><<>>>><>><<>><<><<>>><<>><<<>>><<><>><>>><<<>>>><<>>>><<<>>>><<>>><<<><<<<>>><<<><<><<<>>>><<>><<<<>><<><<<><<>>><<>>><<<<>>>><<>>><<<<><<<<>>><><>>><<<>>><<><<<<>>>><>>>><<<<><<<>>>><>>>><<<><<<>><<<<>>>><>>>><<<<><<>>>><<>><<>><><<>>><<<>>><<<>>>><<<>><<<<>><>>><<>><<<>>>><<>>><<><<>>><<<<><<><<>>>><<<>>>><<<<>><><>>>><<<<>>>><<>>>><<>>><><<>><<<<>>>><<<<><<<<>>>><<<><<<>><>>>><<<<>>>><<>>><<><<>>>><<<>>><<>>><><<>>><<<<><>>>><<<>>>><<<>>><>>><<<<>>><>><<><>>><<>>><<><>>>><<<><<<>><<<<><<<<>>>><<<<>>><>>>><<>>>><<>><<>><<<<>>><<<>>>><<<>>>><<<<>><<>>>><>>>><>>><<<>>><<>><<<><<<>><>>>><<>>><>><<>>><<<<>><>>>><<<<><<<>>><<>><<<>><<<><<<>>><<<>>>><<<><<<<>>>><<<<><>>>><>><<<<>><<>>>><<><<<<><<<<>>>><><<<<><>><<<<>>>><<<<>>><>>><<>>><<<><<<><<<<><<<>><<>><<<>>>><>><<>>><<<><>>><>>>><<<>>><<<<>>>><>>>><>>><><>>><<<>>>><><><<>>><<<>><>>><<<<>>>><<<<>>>><<<>><>>>><><<<<><><<<><<<<>>>><<><<<<><<><<>>>><>>><<<<>>>><<<><>><<<<>><<<>>><>><>>>><<<>>><><<<<>>><<<>>><><<<<>>><<<<>><<<>><<>>><><>>>><<<>><<<><<><<<<>>>><<<<>>>><<>>>><<>><>>>><<>>>><<<<><<>><<<<><<<>>>><<><<><<<>>>><<<>>>><>><<<>><<>><<<<>><<>><<<>><<<<>>>><<>><<<<>><>><>><<<<><<<<>><<<<><<<>>>><<>><>>>><<<><<>><<>><<<>>>><<<<>>><><>>>><<><<>>><<<<>>>><<>>><<<>>>><<>>><<<>>><<>>><<<<><>>><<<<>>><<<<>><<<><<>><<<<>><<<>>>><<><<<>>><>><>><<<<>>><>>>><><>>><<>>>><>><<>>><<<>>>><>>>><<><><<>>><<<><><<>>><>>>><<>>><<><<<>>>><<<<>><<<<>>>><<<<>>>><<<>>>><<><<<>>><<<><<<<><<>>>><<<<><<<<>>>><<>><<>>><>><<<<>>>><<<>><>>><<<>><>>>><>>><<<>><<<>>><<<<>>><<>><<<><><<>>><<<>>>><<<><<>>>><<<><<>>>><>>>><<<<>>><<<<>>>><<<>>>><<<>>><<<<>>><<>><<<>><<<>>><<<><<<>>><<<<>><<>>><>>>><<<<><>>>><<>><<<>><<>><<<<>>>><><>><<<><<><<<>><<<>>><>>>><<>>>><<>>>><<><<<<>>>><>><<<><<<>><>>><<<>><><<<>>><<<<>>>><>><<><<>>>><<<<><<<<>>><<<>>><<>><>><<<><<>><<<<><<<>><<>><<<<>>><<<<>>>><<<>><<<><<<<>>>><><<<<>><<<>><<<<>><<<>>><<<<>><<><<><>><<<>>><<<<>>><<<<>>><<<>>>><<<>>><<<<>>>><<<<>>><<<>>>><<<>>><>>>><>>>><<<>><<<<>><>>><<>>><<<>>><>>'
NUM_JETS = len(JETS)
TETROMINOES = [
    Tetromino(  # -
        lambda field, x, y: field[y - 1, x:x+4],
        [(0, 1, 0, 4)],
        1,
        lambda field, x, y, boundary, mv: field[y, boundary],
        4,
    ),
    Tetromino(  # +
        lambda field, x, y: [field[y - 1, x + 1], field[y, x], field[y, x + 2]],
        [(1, 2, 0, 3), (0, 3, 1, 2)],
        3,
        lambda field, x, y, boundary, mv: np.sum([
            field[y, boundary - mv],
            field[y + 1, boundary],
            field[y + 2, boundary - mv]
        ]),
        3,
    ),
    Tetromino(  # ðŸ­¿
        lambda field, x, y: field[y - 1, x:x+3],
        [(0, 1, 0, 3), (0, 3, 2, 3)],
        3,
        lambda field, x, y, boundary, mv: (field[y, boundary] or np.sum(field[y+1:y+3, x + 2 + mv])),
        3,
    ),
    Tetromino(  # |
        lambda field, x, y: field[y - 1, x],
        [(0, 4, 0, 1)],
        4,
        lambda field, x, y, boundary, mv: np.sum(field[y:y+4, boundary]),
        1,
    ),
    Tetromino(  # â–¡
        lambda field, x, y: field[y - 1, x:x+2],
        [(0, 2, 0, 2)],
        2,
        lambda field, x, y, boundary, mv: np.sum(field[y:y+2, boundary]),
        2,
    ),
]


def _print_field(field: np.ndarray):
    for row in reversed(field):
        print(''.join(('#' if c else '.') for c in row))


def _simulate(n: int) -> int:
    field = np.zeros((5256, 7), dtype=bool)
    highest_point = 0
    jet = 0
    offset = 0
    seen = dict()
    tetromino = 0

    i = 0
    while i < n:
        # print(i)
        # _print_field(field[0:highest_point+3, :])
        # print()

        if (fingerprint := (jet, tetromino, field[highest_point-13:highest_point+1, :].data.tobytes())) in seen:
            j, max_y = seen[fingerprint]
            Î”n, Î”h = (i - j), (highest_point - max_y)
            if periods_remaining := ((n - i) // Î”n):
                i += periods_remaining * Î”n
                offset += periods_remaining * Î”h
                seen = dict()  # nothing else to look at
        else:
            seen[fingerprint] = (i, highest_point)

        y, x = highest_point + 3, 2
        falling = False
        while True:
            t = TETROMINOES[tetromino]
            if falling:
                if y == 0 or np.sum(t.fall_check(field, x, y)):
                    for a, b, c, d in t.footprint:
                        field[y+a:y+b, x+c:x+d] = True
                    highest_point = max(highest_point, y + t.height)
                    break
                else:
                    y -= 1
            else:
                r = JETS[jet] == '>'
                mv = r * 2 - 1
                jet = (jet + 1) % NUM_JETS

                if 0 <= (boundary := x + (t.width - 1) * r + mv) <= 6 and not t.move_check(field, x, y, boundary, mv):
                    x += mv

            falling = not falling

        tetromino = (tetromino + 1) % 5
        i += 1

    return highest_point + offset


def part1():
    return _simulate(2022)


def part2():
    return _simulate(1000000000000)
